{
  "title": "LendingPool: Borrow/repay (variable rate)",
  "description": "Test cases for the borrow function, variable mode.",
  "stories": [
    {
      "description": "User 2 deposits 1 FLEXUSD to account for rounding errors",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1",
            "user": "2"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 deposits 1000 FLEXUSD, user 1 deposits 1 WBCH as collateral and borrows 100 FLEXUSD at variable rate",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "1",
            "timeTravel": "365"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 tries to borrow the rest of the FLEXUSD liquidity (revert expected)",
      "actions": [
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "900",
            "borrowRateMode": "variable",
            "user": "1"
          },
          "expected": "revert",
          "revertMessage": "There is not enough collateral to cover a new borrow"
        }
      ]
    },
    {
      "description": "User 1 tries to repay 0 FLEXUSD (revert expected)",
      "actions": [
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "0",
            "user": "1",
            "onBehalfOf": "1"
          },
          "expected": "revert",
          "revertMessage": "Amount must be greater than 0"
        }
      ]
    },
    {
      "description": "User 1 repays a small amount of FLEXUSD, enough to cover a small part of the interest",
      "actions": [
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1.25",
            "user": "1",
            "onBehalfOf": "1",
            "borrowRateMode": "variable"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 repays the FLEXUSD borrow after one year",
      "actions": [
        {
          "name": "mint",
          "description": "Mint 10 FLEXUSD to cover the interest",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "10",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "1",
            "onBehalfOf": "1",
            "borrowRateMode": "variable"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 withdraws the deposited FLEXUSD plus interest",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "0"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 withdraws the collateral",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "1"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 2 deposits a small amount of WBCH to account for rounding errors",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "0.001",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "0.001",
            "user": "2"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 deposits 1 WBCH, user 1 deposits 100 UNILINKWBCH as collateral and borrows 0.5 WBCH at variable rate",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "mint",
          "args": {
            "reserve": "UNILINKWBCH",
            "amount": "100",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "UNILINKWBCH",
            "user": "1"
          },
          "expected": "success"
        },

        {
          "name": "deposit",
          "args": {
            "reserve": "UNILINKWBCH",
            "amount": "100",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "WBCH",
            "amount": "0.5",
            "borrowRateMode": "variable",
            "user": "1",
            "timeTravel": "365"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 tries to repay 0 WBCH",
      "actions": [
        {
          "name": "repay",
          "args": {
            "reserve": "WBCH",
            "amount": "0",
            "user": "1",
            "onBehalfOf": "1",
            "borrowRateMode": "variable"
          },
          "expected": "revert",
          "revertMessage": "Amount must be greater than 0"
        }
      ]
    },
    {
      "description": "User 2 tries to repay everything on behalf of user 1 using uint(-1) (revert expected)",
      "actions": [
        {
          "name": "repay",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "2",
            "borrowRateMode": "variable",
            "onBehalfOf": "1"
          },
          "expected": "revert",
          "revertMessage": "To repay on behalf of an user an explicit amount to repay is needed"
        }
      ]
    },
    {
      "description": "User 3 repays a small amount of WBCH on behalf of user 1",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "3"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "3"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "WBCH",
            "amount": "0.2",
            "user": "3",
            "borrowRateMode": "variable",
            "onBehalfOf": "1"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 repays the WBCH borrow after one year",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "borrowRateMode": "variable",
            "user": "1",
            "onBehalfOf": "1"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 withdraws the deposited WBCH plus interest",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "0"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 withdraws the collateral",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "UNILINKWBCH",
            "amount": "-1",
            "user": "1"
          },
          "expected": "success"
        }
      ]
    },

    {
      "description": "User 2 deposits 1 FLEXUSD (USDC before) to account for rounding errors",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "2"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1",
            "user": "2"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 deposits 1000 FLEXUSD (USDC before), user 1 deposits 1 WBCH as collateral and borrows 100 FLEXUSD at variable rate",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "1",
            "timeTravel": "365"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 tries to borrow the rest of the FLEXUSD (USDC before) liquidity (revert expected)",
      "actions": [
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "900",
            "borrowRateMode": "variable",
            "user": "1"
          },
          "expected": "revert",
          "revertMessage": "There is not enough collateral to cover a new borrow"
        }
      ]
    },
    {
      "description": "User 1 repays the FLEXUSD (USDC before) borrow after one year",
      "actions": [
        {
          "name": "mint",
          "description": "Mint 10 FLEXUSD to cover the interest",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "10",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "1",
            "onBehalfOf": "1",
            "borrowRateMode": "variable"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 withdraws the deposited FLEXUSD (USDC before) plus interest",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "0"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 withdraws the collateral",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "1"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 deposits 1000 FLEXUSD, user 3 tries to borrow 1000 FLEXUSD without any collateral (revert expected)",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "borrowRateMode": "variable",
            "user": "3"
          },
          "expected": "revert",
          "revertMessage": "The collateral balance is 0"
        }
      ]
    },
    {
      "description": "user 3 deposits 0.1 WBCH collateral to borrow 100 FLEXUSD; 0.1 WBCH is not enough to borrow 100 FLEXUSD (revert expected)",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "0.1",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "0.1",
            "user": "3"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "3"
          },
          "expected": "revert",
          "revertMessage": "There is not enough collateral to cover a new borrow"
        }
      ]
    },
    {
      "description": "user 3 withdraws the 0.1 WBCH",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "3"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 1 deposits 1000 FLEXUSD (USDC before), user 3 tries to borrow 1000 FLEXUSD without any collateral (revert expected)",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "borrowRateMode": "variable",
            "user": "3"
          },
          "expected": "revert",
          "revertMessage": "The collateral balance is 0"
        }
      ]
    },
    {
      "description": "user 3 deposits 0.1 WBCH collateral to borrow 100 FLEXUSD (USDC before); 0.1 WBCH is not enough to borrow 100 FLEXUSD (revert expected)",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "1",
            "user": "3"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "1"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "0.1",
            "user": "3"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "3"
          },
          "expected": "revert",
          "revertMessage": "There is not enough collateral to cover a new borrow"
        }
      ]
    },
    {
      "description": "user 3 withdraws the 0.1 WBCH",
      "actions": [
        {
          "name": "withdraw",
          "args": {
            "reserve": "WBCH",
            "amount": "-1",
            "user": "3"
          },
          "expected": "success"
        }
      ]
    },
    {
      "description": "User 0 deposits 1000 FLEXUSD, user 6 deposits 2 WBCH and borrow 100 FLEXUSD at variable rate first, then 100 FLEXUSD at stable rate (revert expected), then 100 FLEXUSD at variable again, repays everything. User 0 withdraws",
      "actions": [
        {
          "name": "mint",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "1000",
            "user": "0"
          },
          "expected": "success"
        },
        {
          "name": "mint",
          "args": {
            "reserve": "WBCH",
            "amount": "2",
            "user": "6"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "WBCH",
            "user": "6"
          },
          "expected": "success"
        },
        {
          "name": "deposit",
          "args": {
            "reserve": "WBCH",
            "amount": "2",
            "user": "6"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "6",
            "timeTravel": "365"
          },
          "expected": "success"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "stable",
            "user": "6",
            "timeTravel": "365"
          },
          "expected": "revert"
        },
        {
          "name": "borrow",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "100",
            "borrowRateMode": "variable",
            "user": "6",
            "timeTravel": "365"
          },
          "expected": "success"
        },
        {
          "name": "mint",
          "description": "Mint 50 FLEXUSD to cover the interest",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "50",
            "user": "6"
          },
          "expected": "success"
        },
        {
          "name": "approve",
          "args": {
            "reserve": "FLEXUSD",
            "user": "6"
          },
          "expected": "success"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "6",
            "onBehalfOf": "6",
            "borrowRateMode": "stable"
          },
          "expected": "revert"
        },
        {
          "name": "repay",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "6",
            "onBehalfOf": "6",
            "borrowRateMode": "variable"
          },
          "expected": "success"
        },
        {
          "name": "withdraw",
          "args": {
            "reserve": "FLEXUSD",
            "amount": "-1",
            "user": "0"
          },
          "expected": "success"
        }
      ]
    }
  ]
}
